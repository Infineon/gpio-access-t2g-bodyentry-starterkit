# Arduino Due w/ SAM3X8E

# external stlink-v2
source [find /interface/stlink.cfg]

# transport type SWD
transport select hla_swd

# swd frequency
adapter_khz 4000

# sam3x8e cpuid
set CPUTAPID 0x2ba01477

set WORKAREASIZE 0x10000

source [find target/at91sam3XXX.cfg]

# flash bank 0
set _FLASHNAME $_CHIPNAME.flash0
flash bank $_FLASHNAME at91sam3 0x00080000 0 1 1 $_TARGETNAME

# flash bank 1
set _FLASHNAME $_CHIPNAME.flash1
flash bank $_FLASHNAME at91sam3 0x000C0000 0 1 1 $_TARGETNAME

# M24C04
flash bank $_CHIPNAME.m24c04 cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38  4 0x3DC 0x3D8 0x00000010 0x400E0E38 16 0x3DC 0x3D8 0x00010000

# M24C16
flash bank $_CHIPNAME.m24c16 cmspi 0x90000200 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38 23 0x3DC 0x3D8 0x00800000 0x400E0E38 24 0x3DC 0x3D8 0x01000000

# M24C32
flash bank $_CHIPNAME.m24c32 cmspi 0x90000A00 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 23 0x3DC 0x3D8 0x00800000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

# M24256
flash bank $_CHIPNAME.m24256 cmspi 0x90001A00 0 0 0 $_TARGETNAME \
	0x004 0x400E1038 25 0x3DC 0x3D8 0x02000000 0x400E0E38 16 0x3DC 0x3D8 0x00010000

# AT24C512
flash bank $_CHIPNAME.at24c512 cmspi 0x90009A00 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38 22 0x3DC 0x3D8 0x00400000 0x400E0E38 24 0x3DC 0x3D8 0x01000000

# M24M02
flash bank $_CHIPNAME.m24m02 cmspi 0x90019A00 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 28 0x3DC 0x3D8 0x10000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040

# MB85RC16
flash bank $_CHIPNAME.mb85rc16 cmspi 0x90059A00 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 25 0x3DC 0x3D8 0x02000000 0x400E0E38 16 0x3DC 0x3D8 0x00010000

# FM24CL64B
flash bank $_CHIPNAME.fm24cl64b cmspi 0x9005A200 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 26 0x3DC 0x3D8 0x04000000 0x400E0E38 24 0x3DC 0x3D8 0x01000000

# FM24V02
flash bank $_CHIPNAME.fm24v02 cmspi 0x9005C200 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 24 0x3DC 0x3D8 0x01000000 0x400E0E38  6 0x3DC 0x3D8 0x00000040


proc cmi2c_init { } {
	# disable watchdog
	mww 0x400E1A54 0x3FFFAFFF	;# WDT_MR: WDIS=1

	# disable write protection
	mww 0x400E06E4 0x504D4300	;# PMC_WPMR: WPEN=0

	# main on-chip rc oscillator at 8 MHz
	mww 0x400E0620 0x00371018	;# CKGR_MOR: MOSCSEL=0, MOSCXTST=16, MOSCRCF=0x1, MOSCRCEN=1

	# set PLLA output to 80 MHz
	mww 0x400E0628 0x20090A01	;# CKGR_PLLAR: MULA=9, PLLACOUNT=10, DIVA=1
	sleep 10

	# switch to PLLA
	mww 0x400E0630 0x00000002	;# PMC_MCKR: PRES=/1, CSS=PLLA_CLK

	# enable PIO clocks: PIDs 11-16 refer to PIOA-F
	mww 0x400E0610 0x0001F800	;# PMC_PCER0 = PID16|PID15|PID14|PID13|PID12|PID11

	adapter_khz 4000

	# M24C04, A5=SDA: PA04, A0=SCL: PA16
	# PA16:INPUP:H, PA04:INPUP:H
	# Port A: PA16:INPUP:H, PA04:INPUP:H
	mww 0x400E0E00 0x00010010	;# PIO_PER
	mww 0x400E0EA0 0x00010010	;# PIO_OWER
	mww 0x400E0E30 0x00010010	;# PIO_SODR
	mww 0x400E0E64 0x00010010	;# PIO_PUER

	# M24C16, A2=SDA: PA23, A1=SCL: PA24
	# PA24:INPUP:H, PA23:INPUP:H
	# Port A: PA24:INPUP:H, PA23:INPUP:H
	mww 0x400E0E00 0x01800000	;# PIO_PER
	mww 0x400E0EA0 0x01800000	;# PIO_OWER
	mww 0x400E0E30 0x01800000	;# PIO_SODR
	mww 0x400E0E64 0x01800000	;# PIO_PUER

	# M24C32, D7=SDA: PC23, A4=SCL: PA06
	# PA06:INPUP:H, PC23:INPUP:H
	# Port A: PA06:INPUP:H
	mww 0x400E0E00 0x00000040	;# PIO_PER
	mww 0x400E0EA0 0x00000040	;# PIO_OWER
	mww 0x400E0E30 0x00000040	;# PIO_SODR
	mww 0x400E0E64 0x00000040	;# PIO_PUER
	# Port C: PC23:INPUP:H
	mww 0x400E1200 0x00800000	;# PIO_PER
	mww 0x400E12A0 0x00800000	;# PIO_OWER
	mww 0x400E1230 0x00800000	;# PIO_SODR
	mww 0x400E1264 0x00800000	;# PIO_PUER

	# M24256, D2=SDA: PB25, A0=SCL: PA16
	# PA16:INPUP:H, PB25:INPUP:H
	# Port A: PA16:INPUP:H
	mww 0x400E0E00 0x00010000	;# PIO_PER
	mww 0x400E0EA0 0x00010000	;# PIO_OWER
	mww 0x400E0E30 0x00010000	;# PIO_SODR
	mww 0x400E0E64 0x00010000	;# PIO_PUER
	# Port B: PB25:INPUP:H
	mww 0x400E1000 0x02000000	;# PIO_PER
	mww 0x400E10A0 0x02000000	;# PIO_OWER
	mww 0x400E1030 0x02000000	;# PIO_SODR
	mww 0x400E1064 0x02000000	;# PIO_PUER

	# AT24C512, A3=SDA: PA22, A1=SCL: PA24
	# PA24:INPUP:H, PA22:INPUP:H
	# Port A: PA24:INPUP:H, PA22:INPUP:H
	mww 0x400E0E00 0x01400000	;# PIO_PER
	mww 0x400E0EA0 0x01400000	;# PIO_OWER
	mww 0x400E0E30 0x01400000	;# PIO_SODR
	mww 0x400E0E64 0x01400000	;# PIO_PUER

	# M24M02, D3=SDA: PC28, A4=SCL: PA06
	# PA06:INPUP:H, PC28:INPUP:H
	# Port A: PA06:INPUP:H
	mww 0x400E0E00 0x00000040	;# PIO_PER
	mww 0x400E0EA0 0x00000040	;# PIO_OWER
	mww 0x400E0E30 0x00000040	;# PIO_SODR
	mww 0x400E0E64 0x00000040	;# PIO_PUER
	# Port C: PC28:INPUP:H
	mww 0x400E1200 0x10000000	;# PIO_PER
	mww 0x400E12A0 0x10000000	;# PIO_OWER
	mww 0x400E1230 0x10000000	;# PIO_SODR
	mww 0x400E1264 0x10000000	;# PIO_PUER

	# MB85RC16, D5=SDA: PC25, A0=SCL: PA16
	# PA16:INPUP:H, PC25:INPUP:H
	# Port A: PA16:INPUP:H
	mww 0x400E0E00 0x00010000	;# PIO_PER
	mww 0x400E0EA0 0x00010000	;# PIO_OWER
	mww 0x400E0E30 0x00010000	;# PIO_SODR
	mww 0x400E0E64 0x00010000	;# PIO_PUER
	# Port C: PC25:INPUP:H
	mww 0x400E1200 0x02000000	;# PIO_PER
	mww 0x400E12A0 0x02000000	;# PIO_OWER
	mww 0x400E1230 0x02000000	;# PIO_SODR
	mww 0x400E1264 0x02000000	;# PIO_PUER

	# FM24CL64B, D4=SDA: PC26, A1=SCL: PA24
	# PA24:INPUP:H, PC26:INPUP:H
	# Port A: PA24:INPUP:H
	mww 0x400E0E00 0x01000000	;# PIO_PER
	mww 0x400E0EA0 0x01000000	;# PIO_OWER
	mww 0x400E0E30 0x01000000	;# PIO_SODR
	mww 0x400E0E64 0x01000000	;# PIO_PUER
	# Port C: PC26:INPUP:H
	mww 0x400E1200 0x04000000	;# PIO_PER
	mww 0x400E12A0 0x04000000	;# PIO_OWER
	mww 0x400E1230 0x04000000	;# PIO_SODR
	mww 0x400E1264 0x04000000	;# PIO_PUER

	# FM24V02, D6=SDA: PC24, A4=SCL: PA06
	# PA06:INPUP:H, PC24:INPUP:H
	# Port A: PA06:INPUP:H
	mww 0x400E0E00 0x00000040	;# PIO_PER
	mww 0x400E0EA0 0x00000040	;# PIO_OWER
	mww 0x400E0E30 0x00000040	;# PIO_SODR
	mww 0x400E0E64 0x00000040	;# PIO_PUER
	# Port C: PC24:INPUP:H
	mww 0x400E1200 0x01000000	;# PIO_PER
	mww 0x400E12A0 0x01000000	;# PIO_OWER
	mww 0x400E1230 0x01000000	;# PIO_SODR
	mww 0x400E1264 0x01000000	;# PIO_PUER


	cmspi set 2 m24c04 0x200 0x10 0xAC 1 1
	cmspi set 3 m24c16 0x800 0x10 0xA0 3 1
	cmspi set 4 m24c32 0x1000 0x20 0xAE 0 1
	cmspi set 5 m24256 0x8000 0x40 0xAE 0 1
	cmspi set 6 at24c512 0x10000 0x80 0xAE 0 1
	cmspi set 7 m24m02 0x40000 0x100 0xA8 2 1
	cmspi set 8 mb85rc16 0x800 0x100 0xA0 3 1
	cmspi set 9 fm24cl64 0x2000 0x100 0xAE 0 1
	cmspi set 10 fm24v02 0x8000 0x100 0xAE 0 1
}

$_TARGETNAME configure -event reset-init {
	cmi2c_init
}
