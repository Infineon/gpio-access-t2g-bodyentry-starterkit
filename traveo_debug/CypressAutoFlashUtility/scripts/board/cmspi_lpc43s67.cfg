source [find interface/cmsis-dap.cfg]

set WORKAREASIZE 0x08000

source [find target/lpc4350.cfg]

source [find mem_helper.tcl]

set _TARGETNAME $_CHIPNAME.m4

set _FLASHNAME $_CHIPNAME.flash

flash bank $_CHIPNAME.mx25L8035e cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0x000 0x400F6114 11 0x40083000  6 \
	0x400F6104 14 0x300 0x300 0x00004000 0x400F6104 15 0x300 0x300 0x00008000 \
	0x400F6100  6 0x300 0x300 0x00000040 0x400F6114 10 0x300 0x300 0x00000400

flash bank $_CHIPNAME.a7002cm cmspi 0x90100000 0 0 0 $_TARGETNAME \
	0x000 0x400F6114  3 0x300 0x300 0x00000008 0x400F6114  4 0x300 0x300 0x00000010

proc cmspi_init { } {
	# adjust clock to 144 MHz
	mww 0x40050044 0x060B0080				;# PLL1_CTRL: Crystal, MSEL=11, N=1, P=1 , DIRECT=1, FBSEL=0, BYPASS=0

	# MX25L8035E
	# P3_08->FUNC4->GPIO5[11]:PPUP:L, P3_07->FUNC4->GPIO5[10]:INPUP:H,, P3_06->FUNC0->GPIO0[06]:INPUP:H,
	# P3_05->FUNC0->GPIO1[15]:INPUP:H, P3_04->FUNC0->GPIO1[14]:INPUP:H, P3_03->none:PPUP:H,
	# GPIO0: P3_06->FUNC0->GPIO0[06]:INPUP:H
	mww 0x40086198 0xE0						;# SFSP3_06
	mmw 0x400F6000 0x00000000 0x00000040	;# GPIO_DIR0
	mmw 0x400F6100 0x00000040 0x00000000	;# GPIO_PIN0
	# GPIO1: P3_05->FUNC0->GPIO1[15]:INPUP:H, P3_04->FUNC0->GPIO1[14]:INPUP:H
	mww 0x40086190 0xE0						;# SFSP3_04
	mww 0x40086194 0xE0						;# SFSP3_05
	mmw 0x400F6004 0x00000000 0x0000C000	;# GPIO_DIR1
	mmw 0x400F6104 0x0000C000 0x00000000	;# GPIO_PIN1
	# GPIO5: P3_08->FUNC4->GPIO5[11]:PPUP:L, P3_07->FUNC4->GPIO5[10]:INPUP:H
	mww 0x4008619C 0xE4						;# SFSP3_07
	mww 0x400861A0 0x44						;# SFSP3_08
	mmw 0x400F6014 0x00000800 0x00000400	;# GPIO_DIR5
	mmw 0x400F6114 0x00000C00 0x00000000	;# GPIO_PIN5
	# No GPIO: P3_03->none:PPUP:H, emulate GPIO via CPOL bit in SSP_CR0
	mww 0x4008618C 0x22						;# SFSP3_03: MODE=0x2 (SSP0_SCLK), EHS=1
	mww 0x40083004 0x00000000				;# SSP_CR1: disable SSP0
	mww 0x40083000 0x00000047				;# SSP_CR0: CPOL=1 => P3_03=1

	# A7002CM: JS3 and JS4 must be moved to 2-3
	# P2_03->FUNC4->GPIO5[03]:INPUP:L, P2_04->FUNC4->GPIO5[04]:INPUP:L
	# GPIO5: P2_04->FUNC4->GPIO5[04]:INPUP:L, P2_03->FUNC4->GPIO5[03]:INPUP:L
	mww 0x4008610C 0x44						;# SFSP2_03
	mww 0x40086110 0x44						;# SFSP2_04
	mmw 0x400F6014 0x00000000 0x00000018    ;# GPIO_DIR5
	mmw 0x400F6114 0x00000018 0x00000000    ;# GPIO_PIN5

	# A7002CM, default address 0x90
	cmspi set 1 a7002cm 0x100 0x10 0x90 0 30
}

$_TARGETNAME configure -event reset-init {
	cmspi_init
}
