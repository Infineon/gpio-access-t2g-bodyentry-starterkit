# Sample configs for SPI Flash Nucleo-G071RB

# This is for using the onboard STLINK/V2
source [find interface/stlink.cfg]

transport select hla_swd

set WORKAREASIZE 0x5000

source [find target/stm32g0x.cfg]

# W25Q256-A
flash bank $_CHIPNAME.w25q256-a cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0x3FC 0x50000014  0 0x50000014  4 \
	0x50000414  3 0x3EC 0x3EC 0x00000040 0x50000014 10 0x3EC 0x3EC 0x00100000 \
	0x50000414 11 0x3EC 0x3EC 0x00400000 0x50000414  1 0x3EC 0x3EC 0x00000004

# W25Q256-B
flash bank $_CHIPNAME.w25q256-b cmspi 0x91000000 0 0 0 $_TARGETNAME \
	0x3FC 0x50000014  1 0x50000014  4 \
	0x50000014  8 0x3EC 0x3EC 0x00010000 0x50000414 14 0x3EC 0x3EC 0x10000000 \
	0x50000414  4 0x3EC 0x3EC 0x00000100 0x50000414  5 0x3EC 0x3EC 0x00000400

proc cmspi_init { } {
	# RCC_IOPENR |= GPIOFEN|GPIODEN|GPIOCEN|GPIOBEN|GPIOAEN
	mmw 0x40021034 0x0000002F 0

	mmw 0x40022000 0x00000002 0x00000005	;# FLASH_ACR: LATENCY=2
	mmw 0x40007000 0x00000200 0x00000400	;# PWR_CR1: VOS=Range 1

	mww 0x4002100C 0x70000F02				;# 60 MHz: RCC_PLLCFGR: PLLR=/4, PLLREN=1, PLLN=*15, PLLM=/1, PLLSRC=HSI16
	mmw 0x40021000 0x01000000 0				;# RCC_CR |= PLLON
	sleep 1

	mww 0x40021008 0x00000000				;# RCC_CFGR: PPRE=/1, HPRE=/1
	mmw 0x40021008 0x00000002 0x00000005	;# RCC_CFGR: SW=PLLRCLK

	adapter_khz 4000

	# W25Q256-A, A0=NCS: PA00, A2=SCLK: PA04, D3=IO03/NHOLD: PB03, D2=IO02/NWP: PA10, A4=IO01/MISO: PB11, A3=IO00/MOSI: PB01
	# PA10:INPUP:V, PA04:PPUP:V, PA00:PPUP:H, PB11:INPUP:H, PB03:INPUP:V, PB01:INPUP:H
	# Port A: PA10:INPUP:V, PA04:PPUP:V, PA00:PPUP:H
	mmw 0x50000000 0x00000101 0x00300202	;# MODER
	mmw 0x50000004 0x00000000 0x00000411	;# OTYPER
	mmw 0x50000008 0x00300302 0x00000001	;# OSPEEDR
	mmw 0x5000000C 0x00100101 0x00200202	;# PUPDR
	mmw 0x50000014 0x00000411 0x00000000	;# ODR
	# Port B: PB11:INPUP:H, PB03:INPUP:V, PB01:INPUP:H
	mmw 0x50000400 0x00000000 0x00C000CC	;# MODER
	mmw 0x50000404 0x00000000 0x0000080A	;# OTYPER
	mmw 0x50000408 0x008000C8 0x00400004	;# OSPEEDR
	mmw 0x5000040C 0x00400044 0x00800088	;# PUPDR
	mmw 0x50000414 0x0000080A 0x00000000	;# ODR

	# W25Q256-B, A1=NCS: PA01, A2=SCLK: PA04, D7=IO03/NHOLD: PA08, D6=IO02/NWP: PB14, D5=IO01/MISO: PB04, D4=IO00/MOSI: PB05
	# PA08:INPUP:V, PA04:PPUP:V, PA01:PPUP:H, PB14:INPUP:V, PB05:INPUP:V, PB04:INPUP:V
	# Port A: PA08:INPUP:V, PA04:PPUP:V, PA01:PPUP:H
	mmw 0x50000000 0x00000104 0x00030208	;# MODER
	mmw 0x50000004 0x00000000 0x00000112	;# OTYPER
	mmw 0x50000008 0x00030308 0x00000004	;# OSPEEDR
	mmw 0x5000000C 0x00010104 0x00020208	;# PUPDR
	mmw 0x50000014 0x00000112 0x00000000	;# ODR
	# Port B: PB14:INPUP:V, PB05:INPUP:V, PB04:INPUP:V
	mmw 0x50000400 0x00000000 0x30000F00	;# MODER
	mmw 0x50000404 0x00000000 0x00004030	;# OTYPER
	mmw 0x50000408 0x30000F00 0x00000000	;# OSPEEDR
	mmw 0x5000040C 0x10000500 0x20000A00	;# PUPDR
	mmw 0x50000414 0x00004030 0x00000000	;# ODR

	#cmspi set 1 w25q256fv 0x2000000 0x100 0x03 0xEB 0x02 0xC7 0x10000 0xD8
	# exit QPI mode, enter 4-byte mode, enter QPI mode, show status register 3 and 2
	cmspi cmd 1 0 0xFF; cmspi cmd 1 1 0x15; cmspi cmd 1 0 0xB7; cmspi cmd 1 1 0x15
	cmspi cmd 1 0 0x38; cmspi qpi 1 2; cmspi cmd 1 1 0x35

	#cmspi set 2 w25q256fv 0x2000000 0x100 0x03 0xEB 0x02 0xC7 0x10000 0xD8
	# exit QPI mode, enter 4-byte mode, enter QPI mode, show status register 3 and 2
	cmspi cmd 2 0 0xFF; cmspi cmd 2 1 0x15; cmspi cmd 2 0 0xB7; cmspi cmd 2 1 0x15
	cmspi cmd 2 0 0x38; cmspi qpi 2 2; cmspi cmd 2 1 0x35
}

$_TARGETNAME configure -event reset-init {
	cmspi_init
}


