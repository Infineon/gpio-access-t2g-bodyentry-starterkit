# Sample configs for I2C EEPROMs and FRAMs with Nucleo-G071RB

# This is for using the onboard STLINK/V2
source [find interface/stlink.cfg]

transport select hla_swd

set WORKAREASIZE 0x5000

source [find target/stm32g0x.cfg]

# M24C04
flash bank $_CHIPNAME.m24c04 cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0x3FC 0x50000414 12 0x3EC 0x3EC 0x01000000 0x50000014  0 0x3EC 0x3EC 0x00000001

# M24C16
flash bank $_CHIPNAME.m24c16 cmspi 0x90000200 0 0 0 $_TARGETNAME \
	0x3FC 0x50000014  4 0x3EC 0x3EC 0x00000100 0x50000014  1 0x3EC 0x3EC 0x00000004

# M24C32
flash bank $_CHIPNAME.m24c32 cmspi 0x90000A00 0 0 0 $_TARGETNAME \
	0x3FC 0x50000014  8 0x3EC 0x3EC 0x00010000 0x50000414 11 0x3EC 0x3EC 0x00400000

# M24256
flash bank $_CHIPNAME.m24256 cmspi 0x90001A00 0 0 0 $_TARGETNAME \
	0x3FC 0x50000014 10 0x3EC 0x3EC 0x00100000 0x50000014  0 0x3EC 0x3EC 0x00000001

# AT24C512
flash bank $_CHIPNAME.at24c512 cmspi 0x90009A00 0 0 0 $_TARGETNAME \
	0x3FC 0x50000414  1 0x3EC 0x3EC 0x00000004 0x50000014  1 0x3EC 0x3EC 0x00000004

# M24M02
flash bank $_CHIPNAME.m24m02 cmspi 0x90019A00 0 0 0 $_TARGETNAME \
	0x3FC 0x50000414  3 0x3EC 0x3EC 0x00000040 0x50000414 11 0x3EC 0x3EC 0x00400000

# MB85RC16
flash bank $_CHIPNAME.mb85rc16 cmspi 0x90059A00 0 0 0 $_TARGETNAME \
	0x3FC 0x50000414  4 0x3EC 0x3EC 0x00000100 0x50000014  0 0x3EC 0x3EC 0x00000001

# FM24CL64B
flash bank $_CHIPNAME.fm24cl64b cmspi 0x9005A200 0 0 0 $_TARGETNAME \
	0x3FC 0x50000414  5 0x3EC 0x3EC 0x00000400 0x50000014  1 0x3EC 0x3EC 0x00000004

# FM24V02
flash bank $_CHIPNAME.fm24v02 cmspi 0x9005C200 0 0 0 $_TARGETNAME \
	0x3FC 0x50000414 14 0x3EC 0x3EC 0x10000000 0x50000414 11 0x3EC 0x3EC 0x00400000

proc cmi2c_init { } {
	# RCC_IOPENR |= GPIOFEN|GPIODEN|GPIOCEN|GPIOBEN|GPIOAEN
	mmw 0x40021034 0x0000002F 0

	mmw 0x40022000 0x00000002 0x00000005	;# FLASH_ACR: LATENCY=2
	mmw 0x40007000 0x00000200 0x00000400	;# PWR_CR1: VOS=Range 1

	mww 0x4002100C 0x70000F02				;# 60 MHz: RCC_PLLCFGR: PLLR=/4, PLLREN=1, PLLN=*15, PLLM=/1, PLLSRC=HSI16
	mmw 0x40021000 0x01000000 0				;# RCC_CR |= PLLON
	sleep 1

	mww 0x40021008 0x00000000				;# RCC_CFGR: PPRE=/1, HPRE=/1
	mmw 0x40021008 0x00000002 0x00000005	;# RCC_CFGR: SW=PLLRCLK

	adapter_khz 4000

	# M24C04, A5=SDA: PB12, A0=SCL: PA00
	# PA00:INPUP:L, PB12:INPUP:L
	# Port A: PA00:INPUP:L
	mmw 0x50000000 0x00000000 0x00000003	;# MODER
	mmw 0x50000004 0x00000000 0x00000001	;# OTYPER
	mmw 0x50000008 0x00000000 0x00000003	;# OSPEEDR
	mmw 0x5000000C 0x00000001 0x00000002	;# PUPDR
	mmw 0x50000014 0x00000001 0x00000000	;# ODR
	# Port B: PB12:INPUP:L
	mmw 0x50000400 0x00000000 0x03000000	;# MODER
	mmw 0x50000404 0x00000000 0x00001000	;# OTYPER
	mmw 0x50000408 0x00000000 0x03000000	;# OSPEEDR
	mmw 0x5000040C 0x01000000 0x02000000	;# PUPDR
	mmw 0x50000414 0x00001000 0x00000000	;# ODR

	# M24C16, A2=SDA: PA04, A1=SCL: PA01
	# PA04:INPUP:L, PA01:INPUP:L
	# Port A: PA04:INPUP:L, PA01:INPUP:L
	mmw 0x50000000 0x00000000 0x0000030C	;# MODER
	mmw 0x50000004 0x00000000 0x00000012	;# OTYPER
	mmw 0x50000008 0x00000000 0x0000030C	;# OSPEEDR
	mmw 0x5000000C 0x00000104 0x00000208	;# PUPDR
	mmw 0x50000014 0x00000012 0x00000000	;# ODR

	# M24C32, D7=SDA: PA08, A4=SCL: PB11
	# PA08:INPUP:L, PB11:INPUP:L
	# Port A: PA08:INPUP:L
	mmw 0x50000000 0x00000000 0x00030000	;# MODER
	mmw 0x50000004 0x00000000 0x00000100	;# OTYPER
	mmw 0x50000008 0x00000000 0x00030000	;# OSPEEDR
	mmw 0x5000000C 0x00010000 0x00020000	;# PUPDR
	mmw 0x50000014 0x00000100 0x00000000	;# ODR
	# Port B: PB11:INPUP:L
	mmw 0x50000400 0x00000000 0x00C00000	;# MODER
	mmw 0x50000404 0x00000000 0x00000800	;# OTYPER
	mmw 0x50000408 0x00000000 0x00C00000	;# OSPEEDR
	mmw 0x5000040C 0x00400000 0x00800000	;# PUPDR
	mmw 0x50000414 0x00000800 0x00000000	;# ODR

	# M24256, D2=SDA: PA10, A0=SCL: PA00
	# PA10:INPUP:L, PA00:INPUP:L
	# Port A: PA10:INPUP:L, PA00:INPUP:L
	mmw 0x50000000 0x00000000 0x00300003	;# MODER
	mmw 0x50000004 0x00000000 0x00000401	;# OTYPER
	mmw 0x50000008 0x00000000 0x00300003	;# OSPEEDR
	mmw 0x5000000C 0x00100001 0x00200002	;# PUPDR
	mmw 0x50000014 0x00000401 0x00000000	;# ODR

	# AT24C512, A3=SDA: PB01, A1=SCL: PA01
	# PA01:INPUP:L, PB01:INPUP:L
	# Port A: PA01:INPUP:L
	mmw 0x50000000 0x00000000 0x0000000C	;# MODER
	mmw 0x50000004 0x00000000 0x00000002	;# OTYPER
	mmw 0x50000008 0x00000000 0x0000000C	;# OSPEEDR
	mmw 0x5000000C 0x00000004 0x00000008	;# PUPDR
	mmw 0x50000014 0x00000002 0x00000000	;# ODR
	# Port B: PB01:INPUP:L
	mmw 0x50000400 0x00000000 0x0000000C	;# MODER
	mmw 0x50000404 0x00000000 0x00000002	;# OTYPER
	mmw 0x50000408 0x00000000 0x0000000C	;# OSPEEDR
	mmw 0x5000040C 0x00000004 0x00000008	;# PUPDR
	mmw 0x50000414 0x00000002 0x00000000	;# ODR

	# M24M02, D3=SDA: PB03, A4=SCL: PB11
	# PB11:INPUP:L, PB03:INPUP:L
	# Port B: PB11:INPUP:L, PB03:INPUP:L
	mmw 0x50000400 0x00000000 0x00C000C0	;# MODER
	mmw 0x50000404 0x00000000 0x00000808	;# OTYPER
	mmw 0x50000408 0x00000000 0x00C000C0	;# OSPEEDR
	mmw 0x5000040C 0x00400040 0x00800080	;# PUPDR
	mmw 0x50000414 0x00000808 0x00000000	;# ODR

	# MB85RC16, D5=SDA: PB04, A0=SCL: PA00
	# PA00:INPUP:L, PB04:INPUP:L
	# Port A: PA00:INPUP:L
	mmw 0x50000000 0x00000000 0x00000003	;# MODER
	mmw 0x50000004 0x00000000 0x00000001	;# OTYPER
	mmw 0x50000008 0x00000000 0x00000003	;# OSPEEDR
	mmw 0x5000000C 0x00000001 0x00000002	;# PUPDR
	mmw 0x50000014 0x00000001 0x00000000	;# ODR
	# Port B: PB04:INPUP:L
	mmw 0x50000400 0x00000000 0x00000300	;# MODER
	mmw 0x50000404 0x00000000 0x00000010	;# OTYPER
	mmw 0x50000408 0x00000000 0x00000300	;# OSPEEDR
	mmw 0x5000040C 0x00000100 0x00000200	;# PUPDR
	mmw 0x50000414 0x00000010 0x00000000	;# ODR

	# FM24CL64B, D4=SDA: PB05, A1=SCL: PA01
	# PA01:INPUP:L, PB05:INPUP:L
	# Port A: PA01:INPUP:L
	mmw 0x50000000 0x00000000 0x0000000C	;# MODER
	mmw 0x50000004 0x00000000 0x00000002	;# OTYPER
	mmw 0x50000008 0x00000000 0x0000000C	;# OSPEEDR
	mmw 0x5000000C 0x00000004 0x00000008	;# PUPDR
	mmw 0x50000014 0x00000002 0x00000000	;# ODR
	# Port B: PB05:INPUP:L
	mmw 0x50000400 0x00000000 0x00000C00	;# MODER
	mmw 0x50000404 0x00000000 0x00000020	;# OTYPER
	mmw 0x50000408 0x00000000 0x00000C00	;# OSPEEDR
	mmw 0x5000040C 0x00000400 0x00000800	;# PUPDR
	mmw 0x50000414 0x00000020 0x00000000	;# ODR

	# FM24V02, D6=SDA: PB14, A4=SCL: PB11
	# PB14:INPUP:L, PB11:INPUP:L
	# Port B: PB14:INPUP:L, PB11:INPUP:L
	mmw 0x50000400 0x00000000 0x30C00000	;# MODER
	mmw 0x50000404 0x00000000 0x00004800	;# OTYPER
	mmw 0x50000408 0x00000000 0x30C00000	;# OSPEEDR
	mmw 0x5000040C 0x10400000 0x20800000	;# PUPDR
	mmw 0x50000414 0x00004800 0x00000000	;# ODR

	cmspi set 1 m24c04 0x200 0x10 0xAC 1 6
	cmspi set 2 m24c16 0x800 0x10 0xA0 3 6
	cmspi set 3 m24c32 0x1000 0x20 0xAE 0 6
	cmspi set 4 m24256 0x8000 0x40 0xAE 0 6
	cmspi set 5 at24c512 0x10000 0x80 0xAE 0 6
	cmspi set 6 m24m02 0x40000 0x100 0xA8 2 6
	cmspi set 7 mb85rc16 0x800 0x100 0xA0 3 6
	cmspi set 8 fm24cl64 0x2000 0x100 0xAE 0 6
	cmspi set 9 fm24v02 0x8000 0x100 0xAE 0 6
}

$_TARGETNAME configure -event reset-init {
	cmi2c_init
}
