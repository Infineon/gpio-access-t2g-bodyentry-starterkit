# This is an nucleo-f767zi with a single STM32H767ZIT6U chip.
# http://www.st.com/en/evaluation-tools/nucleo-f767zi.html
#
# Two Winbond W25Q256FV attached, dual-1-line or dual-4-line mode
#

# This is for using the onboard STLINK
source [find interface/stlink.cfg]

transport select hla_swd

# increase working area to 256KB
set WORKAREASIZE 0x40000

source [find target/stm32f7x.cfg]

#reset_config srst_only srst_nogate connect_assert_srst

# W25Q256-A
flash bank $_CHIPNAME.w25q256-a cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0x3FC 0x40020414  6 0x40020414  2 \
	0x40020C14 13 0x3EC 0x3EC 0x04000000 0x40021014  2 0x3EC 0x3EC 0x00000010 \
	0x40020C14 12 0x3EC 0x3EC 0x01000000 0x40020C14 11 0x3EC 0x3EC 0x00400000

# W25Q256-B
flash bank $_CHIPNAME.w25q256-b cmspi 0x91000000 0 0 0 $_TARGETNAME \
	0x3FC 0x40020814 11 0x40020414  2 \
	0x40021814 14 0x3EC 0x3EC 0x10000000 0x40021814  9 0x3EC 0x3EC 0x00040000 \
	0x40021014  8 0x3EC 0x3EC 0x00010000 0x40021014  7 0x3EC 0x3EC 0x00004000

proc cmqpi_init { } {
	mmw 0x40023830 0x000007FF 0				;# RCC_AHB1ENR |= GPIOA-GPIOK (enable clocks)
	mmw 0x40023838 0x00000002 0				;# RCC_AHB3ENR |= QSPIEN (enable clock)
	sleep 1									;# Wait for clock startup

	# PB06: BK1_NCS, PB02: CLK, PD13: BK1_IO3, PE02: BK1_IO2, PD12: BK1_IO1, PD11: BK1_IO0
	# PB06:PPUP:M, PB02:PPUP:V, PD13:INPUP:V, PD12:INPUP:V, PD11:INPUP:V, PE02:INPUP:V
	# Port B: PB06:PPUP:M, PB02:PPUP:V
	mmw 0x40020400 0x00001010 0x00002020	;# MODER
	mmw 0x40020404 0x00000000 0x00000044	;# OTYPER
	mmw 0x40020408 0x00001030 0x00002000	;# OSPEEDR
	mmw 0x4002040C 0x00001010 0x00002020	;# PUPDR
	mmw 0x40020414 0x00000044 0x00000000	;# ODR
	# Port D: PD13:INPUP:V, PD12:INPUP:V, PD11:INPUP:V
	mmw 0x40020C00 0x00000000 0x0FC00000	;# MODER
	mmw 0x40020C04 0x00000000 0x00003800	;# OTYPER
	mmw 0x40020C08 0x0FC00000 0x00000000	;# OSPEEDR
	mmw 0x40020C0C 0x05400000 0x0A800000	;# PUPDR
	mmw 0x40020C14 0x00003800 0x00000000	;# ODR
	# Port E: PE02:INPUP:V
	mmw 0x40021000 0x00000000 0x00000030	;# MODER
	mmw 0x40021004 0x00000000 0x00000004	;# OTYPER
	mmw 0x40021008 0x00000030 0x00000000	;# OSPEEDR
	mmw 0x4002100C 0x00000010 0x00000020	;# PUPDR
	mmw 0x40021014 0x00000004 0x00000000	;# ODR

	# PC11: BK2_NCS, PB02: CLK, PG14: BK2_IO3, PG09: BK2_IO2, PE08: BK2_IO1, PE07: BK2_IO0
	# PB02:PPUP:V, PC11:PPUP:M, PE08:INPUP:V, PE07:INPUP:V, PG14:INPUP:V, PG09:INPUP:V
	# Port B: PB02:PPUP:V
	mmw 0x40020400 0x00000010 0x00000020	;# MODER
	mmw 0x40020404 0x00000000 0x00000004	;# OTYPER
	mmw 0x40020408 0x00000030 0x00000000	;# OSPEEDR
	mmw 0x4002040C 0x00000010 0x00000020	;# PUPDR
	mmw 0x40020414 0x00000004 0x00000000	;# ODR
	# Port C: PC11:PPUP:M
	mmw 0x40020800 0x00400000 0x00800000	;# MODER
	mmw 0x40020804 0x00000000 0x00000800	;# OTYPER
	mmw 0x40020808 0x00400000 0x00800000	;# OSPEEDR
	mmw 0x4002080C 0x00400000 0x00800000	;# PUPDR
	mmw 0x40020814 0x00000800 0x00000000	;# ODR
	# Port E: PE08:INPUP:V, PE07:INPUP:V
	mmw 0x40021000 0x00000000 0x0003C000	;# MODER
	mmw 0x40021004 0x00000000 0x00000180	;# OTYPER
	mmw 0x40021008 0x0003C000 0x00000000	;# OSPEEDR
	mmw 0x4002100C 0x00014000 0x00028000	;# PUPDR
	mmw 0x40021014 0x00000180 0x00000000	;# ODR
	# Port G: PG14:INPUP:V, PG09:INPUP:V
	mmw 0x40021800 0x00000000 0x300C0000	;# MODER
	mmw 0x40021804 0x00000000 0x00004200	;# OTYPER
	mmw 0x40021808 0x300C0000 0x00000000	;# OSPEEDR
	mmw 0x4002180C 0x10040000 0x20080000	;# PUPDR
	mmw 0x40021814 0x00004200 0x00000000	;# ODR

	#cmspi set 1 w25q256fv 0x2000000 0x100 0x03 0xEB 0x02 0xC7 0x10000 0xD8
	# exit QPI mode, enter 4-byte mode, enter QPI mode, show status register 3 and 2
	cmspi cmd 1 0 0xFF; cmspi cmd 1 1 0x15; cmspi cmd 1 0 0xB7; cmspi cmd 1 1 0x15
	cmspi cmd 1 0 0x38; cmspi qpi 1 2; cmspi cmd 1 1 0x35

	#cmspi set 2 w25q256fv 0x2000000 0x100 0x03 0xEB 0x02 0xC7 0x10000 0xD8
	# exit QPI mode, enter 4-byte mode, enter QPI mode, show status register 3 and 2
	cmspi cmd 2 0 0xFF; cmspi cmd 2 1 0x15; cmspi cmd 2 0 0xB7; cmspi cmd 2 1 0x15
	cmspi cmd 2 0 0x38; cmspi qpi 2 2; cmspi cmd 2 1 0x35

}

$_TARGETNAME configure -event reset-init {
	mww 0x40023C00 0x00000006				;# 6 WS for 192 MHz HCLK
	sleep 1
	mww 0x40023804 0x24003008				;# 192 MHz: PLLM=8, PLLN=192, PLLP=2
	mww 0x40023808 0x00009400				;# APB1: /4, APB2: /2
	mmw 0x40023800 0x01000000 0x00000000	;# PLL on
	sleep 1
	mmw 0x40023808 0x00000002 0x00000000	;# switch to PLL
	sleep 1

	adapter_khz 24000

	cmqpi_init
}
