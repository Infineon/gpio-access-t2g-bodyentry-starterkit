source [find board/atmel_same70_xplained.cfg]

# W25Q128
flash bank $_CHIPNAME.w25q128 cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 30 0x400E1438 26 \
	0x400E1238 31 0x3DC 0x3D8 0x80000000 0x400E1238 13 0x3DC 0x3D8 0x00002000

# W25Q256
flash bank $_CHIPNAME.w25q256 cmspi 0x91000000 0 0 0 $_TARGETNAME \
	0x004 0x400E1438 30 0x400E1438 26 \
	0x400E1238 31 0x3DC 0x3D8 0x80000000 0x400E1238 13 0x3DC 0x3D8 0x00002000

# M95640
flash bank $_CHIPNAME.m95640 cmspi 0x93000000 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38  2 0x400E1438 26 \
	0x400E1238 31 0x3DC 0x3D8 0x80000000 0x400E1238 13 0x3DC 0x3D8 0x00002000

# M95M02
flash bank $_CHIPNAME.m95m02 cmspi 0x93002000 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38  5 0x400E1438 26 \
	0x400E1238 31 0x3DC 0x3D8 0x80000000 0x400E1238 13 0x3DC 0x3D8 0x00002000

# M95512
flash bank $_CHIPNAME.m95512 cmspi 0x93042000 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38 19 0x400E1438 26 \
	0x400E1238 31 0x3DC 0x3D8 0x80000000 0x400E1238 13 0x3DC 0x3D8 0x00002000

# FM25W256
flash bank $_CHIPNAME.fm25w256 cmspi 0x93052000 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38  6 0x400E1438 26 \
	0x400E1238 31 0x3DC 0x3D8 0x80000000 0x400E1238 13 0x3DC 0x3D8 0x00002000

# MB85RS64
flash bank $_CHIPNAME.mb85rs64 cmspi 0x9305A000 0 0 0 $_TARGETNAME \
	0x004 0x400E1438 11 0x400E1438 26 \
	0x400E1238 31 0x3DC 0x3D8 0x80000000 0x400E1238 13 0x3DC 0x3D8 0x00002000

# FM25V02
#
# MOSI and MISO pins *both* connected to PC13, hence exor mask
# for MISO is 0x00000000 rather than 0x000000B0
#
flash bank $_CHIPNAME.fm25v02 cmspi 0x9305C000 0 0 0 $_TARGETNAME \
	0x004 0x400E1438 27 0x400E1438 26 \
	0x400E1238 13 0x3DC 0x3D8 0x00000000 0x400E1238 13 0x3DC 0x3D8 0x00002000

# FM25V05
flash bank $_CHIPNAME.fm25v05 cmspi 0x93064000 0 0 0 $_TARGETNAME \
	0x004 0x400E1238 19 0x400E1438 26 \
	0x400E1238 31 0x3DC 0x3D8 0x80000000 0x400E1238 13 0x3DC 0x3D8 0x00002000

# AT24MAC402, lower half
flash bank $_CHIPNAME.at24mac402l cmspi 0xA0000000 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38  3 0x3DC 0x3D8 0x00000008 0x400E0E38  4 0x3DC 0x3D8 0x00000010

# AT24MAC402, upper half
flash bank $_CHIPNAME.at24mac402h cmspi 0xA0000100 0 0 0 $_TARGETNAME \
	0x004 0x400E0E38  3 0x3DC 0x3D8 0x00000008 0x400E0E38  4 0x3DC 0x3D8 0x00000010

proc cmspi_init { } {
	# disable watchdog
	mww 0x400E1854 0x3FFFAFFF	;# WDT_MR: WDIS=1

	# disable write protection
	mww 0x400E06E4 0x504D4300	;# PMC_WPMR: WPEN=0

	# main on-chip rc oscillator at 8 MHz
	mww 0x400E0620 0x00371018	;# CKGR_MOR: MOSCSEL=0, MOSCXTST=16, MOSCRCF=0x1, MOSCRCEN=1

	# set PLLA output to 200 MHz
	mww 0x400E0628 0x20180A01	;# CKGR_PLLAR: MULA=24, PLLACOUNT=10, DIVA=1
	sleep 1

	# setup prescalers
	mww 0x400E0630 0x00000101	;# PMC_MCKR: MDIC=/2, PRES=/1, CSS=MAIN_CLK
	sleep 1

	# switch to PLLA
	mww 0x400E0630 0x00000102	;# PMC_MCKR: MDIC=/2, PRES=/1, CSS=PLLA_CLK

	# enable PIO clocks: PIDs 10-12, 16-17 refer to PIOA-E
	mww 0x400E0610 0x00031C00	;# PMC_PCER0 = PID17|PID16|PID12|PID11|PID10

	adapter_khz 4000

	# W25Q128, A5=NCS: PC30, A0=SCLK: PD26, A1=IO01/MISO: PC31, A4=IO00/MOSI: PC13
	# PC31:INPUP:H, PC30:PPUP:H, PC13:INPUP:H, PD26:PPUP:H
	# Port C: PC31:INPUP:H, PC30:PPUP:H, PC13:INPUP:H
	mww 0x400E1200 0xC0002000	;# PIO_PER
	mww 0x400E12A0 0xC0002000	;# PIO_OWER
	mww 0x400E1210 0x40000000	;# PIO_OER
	mww 0x400E1230 0xC0002000	;# PIO_SODR
	mww 0x400E1264 0xC0002000	;# PIO_PUER
	# Port D: PD26:PPUP:H
	mww 0x400E1400 0x04000000	;# PIO_PER
	mww 0x400E14A0 0x04000000	;# PIO_OWER
	mww 0x400E1410 0x04000000	;# PIO_OER
	mww 0x400E1430 0x04000000	;# PIO_SODR
	mww 0x400E1464 0x04000000	;# PIO_PUER

	# W25Q256, A2=NCS: PD30, A0=SCLK: PD26, A1=IO01/MISO: PC31, A4=IO00/MOSI: PC13
	# PC31:INPUP:H, PC13:INPUP:H, PD30:PPUP:H, PD26:PPUP:H
	# Port C: PC31:INPUP:H, PC13:INPUP:H
	mww 0x400E1200 0x80002000	;# PIO_PER
	mww 0x400E12A0 0x80002000	;# PIO_OWER
	mww 0x400E1230 0x80002000	;# PIO_SODR
	mww 0x400E1264 0x80002000	;# PIO_PUER
	# Port D: PD30:PPUP:H, PD26:PPUP:H
	mww 0x400E1400 0x44000000	;# PIO_PER
	mww 0x400E14A0 0x44000000	;# PIO_OWER
	mww 0x400E1410 0x44000000	;# PIO_OER
	mww 0x400E1430 0x44000000	;# PIO_SODR
	mww 0x400E1464 0x44000000	;# PIO_PUER

	# M95640, D7=NCS: PA02, A0=SCLK: PD26, A1=IO01/MISO: PC31, A4=IO00/MOSI: PC13
	# PA02:PPUP:H, PC31:INPUP:H, PC13:INPUP:H, PD26:PPUP:H
	# Port A: PA02:PPUP:H
	mww 0x400E0E00 0x00000004	;# PIO_PER
	mww 0x400E0EA0 0x00000004	;# PIO_OWER
	mww 0x400E0E10 0x00000004	;# PIO_OER
	mww 0x400E0E30 0x00000004	;# PIO_SODR
	mww 0x400E0E64 0x00000004	;# PIO_PUER
	# Port C: PC31:INPUP:H, PC13:INPUP:H
	mww 0x400E1200 0x80002000	;# PIO_PER
	mww 0x400E12A0 0x80002000	;# PIO_OWER
	mww 0x400E1230 0x80002000	;# PIO_SODR
	mww 0x400E1264 0x80002000	;# PIO_PUER
	# Port D: PD26:PPUP:H
	mww 0x400E1400 0x04000000	;# PIO_PER
	mww 0x400E14A0 0x04000000	;# PIO_OWER
	mww 0x400E1410 0x04000000	;# PIO_OER
	mww 0x400E1430 0x04000000	;# PIO_SODR
	mww 0x400E1464 0x04000000	;# PIO_PUER

	# M95M02, D2=NCS: PA05, A0=SCLK: PD26, A1=IO01/MISO: PC31, A4=IO00/MOSI: PC13
	# PA05:PPUP:H, PC31:INPUP:H, PC13:INPUP:H, PD26:PPUP:H
	# Port A: PA05:PPUP:H
	mww 0x400E0E00 0x00000020	;# PIO_PER
	mww 0x400E0EA0 0x00000020	;# PIO_OWER
	mww 0x400E0E10 0x00000020	;# PIO_OER
	mww 0x400E0E30 0x00000020	;# PIO_SODR
	mww 0x400E0E64 0x00000020	;# PIO_PUER
	# Port C: PC31:INPUP:H, PC13:INPUP:H
	mww 0x400E1200 0x80002000	;# PIO_PER
	mww 0x400E12A0 0x80002000	;# PIO_OWER
	mww 0x400E1230 0x80002000	;# PIO_SODR
	mww 0x400E1264 0x80002000	;# PIO_PUER
	# Port D: PD26:PPUP:H
	mww 0x400E1400 0x04000000	;# PIO_PER
	mww 0x400E14A0 0x04000000	;# PIO_OWER
	mww 0x400E1410 0x04000000	;# PIO_OER
	mww 0x400E1430 0x04000000	;# PIO_SODR
	mww 0x400E1464 0x04000000	;# PIO_PUER

	# M95512, A3=NCS: PA19, A0=SCLK: PD26, A1=IO01/MISO: PC31, A4=IO00/MOSI: PC13
	# PA19:PPUP:H, PC31:INPUP:H, PC13:INPUP:H, PD26:PPUP:H
	# Port A: PA19:PPUP:H
	mww 0x400E0E00 0x00080000	;# PIO_PER
	mww 0x400E0EA0 0x00080000	;# PIO_OWER
	mww 0x400E0E10 0x00080000	;# PIO_OER
	mww 0x400E0E30 0x00080000	;# PIO_SODR
	mww 0x400E0E64 0x00080000	;# PIO_PUER
	# Port C: PC31:INPUP:H, PC13:INPUP:H
	mww 0x400E1200 0x80002000	;# PIO_PER
	mww 0x400E12A0 0x80002000	;# PIO_OWER
	mww 0x400E1230 0x80002000	;# PIO_SODR
	mww 0x400E1264 0x80002000	;# PIO_PUER
	# Port D: PD26:PPUP:H
	mww 0x400E1400 0x04000000	;# PIO_PER
	mww 0x400E14A0 0x04000000	;# PIO_OWER
	mww 0x400E1410 0x04000000	;# PIO_OER
	mww 0x400E1430 0x04000000	;# PIO_SODR
	mww 0x400E1464 0x04000000	;# PIO_PUER

	# FM25W256, D3=NCS: PA06, A0=SCLK: PD26, A1=IO01/MISO: PC31, A4=IO00/MOSI: PC13
	# PA06:PPUP:H, PC31:INPUP:H, PC13:INPUP:H, PD26:PPUP:H
	# Port A: PA06:PPUP:H
	mww 0x400E0E00 0x00000040	;# PIO_PER
	mww 0x400E0EA0 0x00000040	;# PIO_OWER
	mww 0x400E0E10 0x00000040	;# PIO_OER
	mww 0x400E0E30 0x00000040	;# PIO_SODR
	mww 0x400E0E64 0x00000040	;# PIO_PUER
	# Port C: PC31:INPUP:H, PC13:INPUP:H
	mww 0x400E1200 0x80002000	;# PIO_PER
	mww 0x400E12A0 0x80002000	;# PIO_OWER
	mww 0x400E1230 0x80002000	;# PIO_SODR
	mww 0x400E1264 0x80002000	;# PIO_PUER
	# Port D: PD26:PPUP:H
	mww 0x400E1400 0x04000000	;# PIO_PER
	mww 0x400E14A0 0x04000000	;# PIO_OWER
	mww 0x400E1410 0x04000000	;# PIO_OER
	mww 0x400E1430 0x04000000	;# PIO_SODR
	mww 0x400E1464 0x04000000	;# PIO_PUER

	# MB85RS64, D5=NCS: PD11, A0=SCLK: PD26, A1=IO01/MISO: PC31, A4=IO00/MOSI: PC13
	# PC31:INPUP:H, PC13:INPUP:H, PD26:PPUP:H, PD11:PPUP:H
	# Port C: PC31:INPUP:H, PC13:INPUP:H
	mww 0x400E1200 0x80002000	;# PIO_PER
	mww 0x400E12A0 0x80002000	;# PIO_OWER
	mww 0x400E1230 0x80002000	;# PIO_SODR
	mww 0x400E1264 0x80002000	;# PIO_PUER
	# Port D: PD26:PPUP:H, PD11:PPUP:H
	mww 0x400E1400 0x04000800	;# PIO_PER
	mww 0x400E14A0 0x04000800	;# PIO_OWER
	mww 0x400E1410 0x04000800	;# PIO_OER
	mww 0x400E1430 0x04000800	;# PIO_SODR
	mww 0x400E1464 0x04000800	;# PIO_PUER

	# FM25V02, D4=NCS: PD27, A0=SCLK: PD26, A1=IO01/MISO: PC31, A4=IO00/MOSI: PC13
	#
	# MOSI and MISO pins *both* connected to PC13, hence PC31 actually not used
	#
	# PC31:INPUP:H, PC13:INPUP:H, PD27:PPUP:H, PD26:PPUP:H
	# Port C: PC31:INPUP:H, PC13:INPUP:H
	mww 0x400E1200 0x80002000	;# PIO_PER
	mww 0x400E12A0 0x80002000	;# PIO_OWER
	mww 0x400E1230 0x80002000	;# PIO_SODR
	mww 0x400E1264 0x80002000	;# PIO_PUER
	# Port D: PD27:PPUP:H, PD26:PPUP:H
	mww 0x400E1400 0x0C000000	;# PIO_PER
	mww 0x400E14A0 0x0C000000	;# PIO_OWER
	mww 0x400E1410 0x0C000000	;# PIO_OER
	mww 0x400E1430 0x0C000000	;# PIO_SODR
	mww 0x400E1464 0x0C000000	;# PIO_PUER

	# FM25V05, D6=NCS: PC19, A0=SCLK: PD26, A1=IO01/MISO: PC31, A4=IO00/MOSI: PC13
	# PC31:INPUP:H, PC19:PPUP:H, PC13:INPUP:H, PD26:PPUP:H
	# Port C: PC31:INPUP:H, PC19:PPUP:H, PC13:INPUP:H
	mww 0x400E1200 0x80082000	;# PIO_PER
	mww 0x400E12A0 0x80082000	;# PIO_OWER
	mww 0x400E1210 0x00080000	;# PIO_OER
	mww 0x400E1230 0x80082000	;# PIO_SODR
	mww 0x400E1264 0x80082000	;# PIO_PUER
	# Port D: PD26:PPUP:H
	mww 0x400E1400 0x04000000	;# PIO_PER
	mww 0x400E14A0 0x04000000	;# PIO_OWER
	mww 0x400E1410 0x04000000	;# PIO_OER
	mww 0x400E1430 0x04000000	;# PIO_SODR
	mww 0x400E1464 0x04000000	;# PIO_PUER

	# AT24MAC402, WP permanently set to '0'
	# PA04:INPUP:H, PA03:INPUP:H, PC11:PPDO:H
	# Port A: PA04:INPUP:H, PA03:INPUP:H
	mww 0x400E0E00 0x00000018	;# PIO_PER
	mww 0x400E0EA0 0x00000018	;# PIO_OWER
	mww 0x400E0E30 0x00000018	;# PIO_SODR
	mww 0x400E0E64 0x00000018	;# PIO_PUER
	# Port C: PC11:PPUP:H
	mww 0x400E1200 0x00000800	;# PIO_PER
	mww 0x400E12A0 0x00000800	;# PIO_OWER
	mww 0x400E1210 0x00000800	;# PIO_OER
	mww 0x400E1234 0x00000800	;# PIO_CODR

	#cmspi set 1 w25q128 0x1000000 0x100 0x03 0x00 0x02 0xC7 0x10000 0xD8
	#cmspi set 2 w25q256fv 0x2000000 0x100 0x03 0x00 0x02 0xC7 0x10000 0xD8
	cmspi cmd 2 1 0x15; cmspi cmd 2 0 0xB7; cmspi cmd 2 1 0x15
	cmspi set 3 m95640 0x2000 0x20 0x03 0x00 0x02
	cmspi set 4 m95m02 0x40000 0x100 0x03 0x00 0x02
	cmspi set 5 m95512 0x10000 0x80 0x03 0x00 0x02
	cmspi set 6 fm25w256 0x8000 0x100 0x03 0x00 0x02
	#cmspi set 7 mb85rs64 0x2000 0x100 0x03 0x00 0x02
	#cmspi set 8 fm25v02 0x8000 0x100 0x03 0x00 0x02
	#cmspi set 9 fm25v05 0x10000 0x100 0x03 0x00 0x02
	cmspi set 10 at24mac402 0x100 0x10 0xAE 0 80
	cmspi set 11 at24mac402 0x100 0x10 0xBE 0 80
}

$_TARGETNAME configure -event reset-init {
	cmspi_init
}
