# Sample configs for I2C EEPROMs and FRAMs with frdm-k64f

source [find interface/cmsis-dap.cfg]

# increase working area to 16KB
set WORKAREASIZE 0x4000

# chip name
set CHIPNAME MK64FN1M0VLL12

source [find mem_helper.tcl]

source [find target/kx.cfg]

kinetis create_banks

cortex_m reset_config sysresetreq

# M24C04
flash bank $_CHIPNAME.m24c04 cmspi 0x90000000 0 0 0 $_TARGETNAME \
	0x010 0x400FF080 10 0x014 0x014 0x00000400 0x400FF040  2 0x014 0x014 0x00000004

# M24C16
flash bank $_CHIPNAME.m24c16 cmspi 0x90000200 0 0 0 $_TARGETNAME \
	0x010 0x400FF040 10 0x014 0x014 0x00000400 0x400FF040  3 0x014 0x014 0x00000008

# M24C32
flash bank $_CHIPNAME.m24c32 cmspi 0x90000A00 0 0 0 $_TARGETNAME \
	0x010 0x400FF080  3 0x014 0x014 0x00000008 0x400FF080 11 0x014 0x014 0x00000800

# M24256
flash bank $_CHIPNAME.m24256 cmspi 0x90001A00 0 0 0 $_TARGETNAME \
	0x010 0x400FF040  9 0x014 0x014 0x00000200 0x400FF040  2 0x014 0x014 0x00000004

# AT24C512
flash bank $_CHIPNAME.at24c512 cmspi 0x90009A00 0 0 0 $_TARGETNAME \
	0x010 0x400FF040 11 0x014 0x014 0x00000800 0x400FF040  3 0x014 0x014 0x00000008

# M24M02
flash bank $_CHIPNAME.m24m02 cmspi 0x90019A00 0 0 0 $_TARGETNAME \
	0x010 0x400FF000  1 0x014 0x014 0x00000002 0x400FF080 11 0x014 0x014 0x00000800

# MB85RC16
flash bank $_CHIPNAME.mb85rc16 cmspi 0x90059A00 0 0 0 $_TARGETNAME \
	0x010 0x400FF000  2 0x014 0x014 0x00000004 0x400FF040  2 0x014 0x014 0x00000004

# FM24CL64B
flash bank $_CHIPNAME.fm24cl64b cmspi 0x9005A200 0 0 0 $_TARGETNAME \
	0x010 0x400FF040 23 0x014 0x014 0x00800000 0x400FF040  3 0x014 0x014 0x00000008

# FM24V02
flash bank $_CHIPNAME.fm24v02 cmspi 0x9005C200 0 0 0 $_TARGETNAME \
	0x010 0x400FF080  2 0x014 0x014 0x00000004 0x400FF080 11 0x014 0x014 0x00000800

proc cmi2c_init { } {
	mww 0x40048044 0x01220000				;# SIM_CLKDIV1: core: /1, bus: /2, flex: /3, flash: /3
	mmb 0x40064003 0x60 0x00				;# MCG_C4: DRST_DRS = 0b11 for approx 80 Mhz
	mmw 0x40048038 0x00003E00 0				;# SIM_SCGC5 |= PORTE|PORTD|PORTC|PORTB|PORTA

	# M24C04, A5=SDA: PC10, A0=SCL: PB02
	# PB02:INOUP:H, PC10:INOUP:H
	# Port B: PB02:INOUP:H
	mmw 0x4004A008 0x00000123 0x00000604	;# PORTB_PCR02
	mmw 0x400FF040 0x00000004 0x00000000	;# PODR
	mmw 0x400FF054 0x00000000 0x00000004	;# PDDR
	# Port C: PC10:INOUP:H
	mmw 0x4004B028 0x00000123 0x00000604	;# PORTC_PCR10
	mmw 0x400FF080 0x00000400 0x00000000	;# PODR
	mmw 0x400FF094 0x00000000 0x00000400	;# PDDR

	# M24C16, A2=SDA: PB10, A1=SCL: PB03
	# PB10:INOUP:H, PB03:INOUP:H
	# Port B: PB10:INOUP:H, PB03:POUP
	mmw 0x4004A00C 0x00000123 0x00000604	;# PORTB_PCR03
	mmw 0x4004A028 0x00000123 0x00000604	;# PORTB_PCR10
	mmw 0x400FF040 0x00000408 0x00000000	;# PODR
	mmw 0x400FF054 0x00000000 0x00000408	;# PDDR

	# M24C32, D7=SDA: PC03, A4=SCL: PC11
	# PC11:INOUP:H, PC03:INOUP:H
	# Port C: PC11:INOUP:H, PC03:INOUP:H
	mmw 0x4004B00C 0x00000123 0x00000604	;# PORTC_PCR03
	mmw 0x4004B02C 0x00000123 0x00000604	;# PORTC_PCR11
	mmw 0x400FF080 0x00000808 0x00000000	;# PODR
	mmw 0x400FF094 0x00000000 0x00000808	;# PDDR

	# M24256, D2=SDA: PB09, A0=SCL: PB02
	# PB09:INOUP:H, PB02:INOUP:H
	# Port B: PB09:INOUP:H, PB02:INOUP:H
	mmw 0x4004A008 0x00000123 0x00000604	;# PORTB_PCR02
	mmw 0x4004A024 0x00000123 0x00000604	;# PORTB_PCR09
	mmw 0x400FF040 0x00000204 0x00000000	;# PODR
	mmw 0x400FF054 0x00000000 0x00000204	;# PDDR

	# AT24C512, A3=SDA: PB11, A1=SCL: PB03
	# PB11:INOUP:H, PB03:INOUP:H
	# Port B: PB11:INOUP:H, PB03:INOUP:H
	mmw 0x4004A00C 0x00000123 0x00000604	;# PORTB_PCR03
	mmw 0x4004A02C 0x00000123 0x00000604	;# PORTB_PCR11
	mmw 0x400FF040 0x00000808 0x00000000	;# PODR
	mmw 0x400FF054 0x00000000 0x00000808	;# PDDR

	# M24M02, D3=SDA: PA01, A4=SCL: PC11
	# PA01:INOUP:H, PC11:INOUP:H
	# Port A: PA01:INOUP:H
	mmw 0x40049004 0x00000123 0x00000604	;# PORTA_PCR01
	mmw 0x400FF000 0x00000002 0x00000000	;# PODR
	mmw 0x400FF014 0x00000000 0x00000002	;# PDDR
	# Port C: PC11:INOUP:H
	mmw 0x4004B02C 0x00000123 0x00000604	;# PORTC_PCR11
	mmw 0x400FF080 0x00000800 0x00000000	;# PODR
	mmw 0x400FF094 0x00000000 0x00000800	;# PDDR

	# MB85RC16, D5=SDA: PA02, A0=SCL: PB02
	# PA02:INOUP:H, PB02:INOUP:H
	# Port A: PA02:INOUP:H
	mmw 0x40049008 0x00000123 0x00000604	;# PORTA_PCR02
	mmw 0x400FF000 0x00000004 0x00000000	;# PODR
	mmw 0x400FF014 0x00000000 0x00000004	;# PDDR
	# Port B: PB02:INOUP:H
	mmw 0x4004A008 0x00000123 0x00000604	;# PORTB_PCR02
	mmw 0x400FF040 0x00000004 0x00000000	;# PODR
	mmw 0x400FF054 0x00000000 0x00000004	;# PDDR

	# FM24CL64B, D4=SDA: PB23, A1=SCL: PB03
	# PB23:INOUP:H, PB03:INOUP:H
	# Port B: PB23:INOUP:H, PB03:INOUP:H
	mmw 0x4004A00C 0x00000123 0x00000604	;# PORTB_PCR03
	mmw 0x4004A05C 0x00000123 0x00000604	;# PORTB_PCR23
	mmw 0x400FF040 0x00800008 0x00000000	;# PODR
	mmw 0x400FF054 0x00000000 0x00800008	;# PDDR

	# FM24V02, D6=SDA: PC02, A4=SCL: PC11
	# PC11:INOUP:H, PC02:INOUP:H
	# Port C: PC11:INOUP:H, PC02:INOUP:H
	mmw 0x4004B008 0x00000123 0x00000604	;# PORTC_PCR02
	mmw 0x4004B02C 0x00000123 0x00000604	;# PORTC_PCR11
	mmw 0x400FF080 0x00000804 0x00000000	;# PODR
	mmw 0x400FF094 0x00000000 0x00000804	;# PDDR

	cmspi set 1 m24c04 0x200 0x010 0xAC 1 20
	cmspi set 2 m24c16 0x800 0x010 0xA0 3 20
	cmspi set 3 m24c32 0x1000 0x20 0xAE 0 20
	cmspi set 4 m24256 0x8000 0x40 0xAE 0 20
	cmspi set 5 at24c512 0x10000 0x80 0xAE 0 20
	cmspi set 6 m24m02 0x40000 0x100 0xA8 2 20
	cmspi set 7 mb85rc16 0x800 0x100 0xA0 3 20
	cmspi set 8 fm24cl64 0x2000 0x100 0xAE 0 20
	cmspi set 9 fm24v02 0x8000 0x100 0xAE 0 20
}

$_TARGETNAME configure -event reset-init {
	kinetis disable_wdog
	cmi2c_init
}
